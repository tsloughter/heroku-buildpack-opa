#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1

echo "-----> Found a Makefile"

# if hello.txt is empty, abort the build
if [ ! -s $1/Makefile ]; then
  echo "Makefile was empty" | indent
  exit 1
fi

echo "-----> Install Opa"
OPA_BINARY="https://s3.amazonaws.com/heroku-opalang2/opalang.tgz"
OPA_VENDOR="vendor/opa"

mkdir -p $1/$OPA_VENDOR
curl $OPA_BINARY -o - | tar -xz -C $1/$OPA_VENDOR -f -

PATH=/app/mlstate-opa/bin:$PATH
export PATH

cd $BUILD_DIR

# run make
#ln -s $1/$OPA_VENDOR /app/mlstate-opa
mkdir -p /app/mlstate-opa
mv $1/$OPA_VENDOR/* /app/mlstate-opa/

ls -l /app/mlstate-opa/lib/opa/bin/opa-bin
/app/mlstate-opa/lib/opa/bin/opa-bin

make